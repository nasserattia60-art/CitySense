{% extends "base/base.html" %}
{% load static %}
{% block title %}CitySense | map{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href=" {% static 'css/dashboard/map.css' %}">
{% endblock %}
{% block content %}
<div class="container map-container">

    <!-- Page Heading -->
    <h2>City Map</h2>

    <!-- Layer Selector -->
    <div class="map-controls">
        <label for="layerSelect">Select Layer:</label>
        <select id="layerSelect">
            <option value="ai_score">AI Score</option>
            <option value="safety">Safety</option>
            <option value="noise">Noise</option>
            <option value="rent">Rent</option>
        </select>
    </div>

    <!-- Map -->
    <div id="map"></div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // Initialize map
    const map = L.map('map').setView([30.0444, 31.2357], 11);

    // Add OSM tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let heatLayer;

    // Function to load heatmap layer
    function loadLayer(type) {
        fetch(`/analyze/heatmap-data/?layer=${type}`)
            .then(res => res.json())
            .then(data => {
                const heatData = data.map(d => [d.lat, d.lng, d.weight / 100]);
                if (heatLayer) {
                    map.removeLayer(heatLayer);
                }
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17
                }).addTo(map);
            })
            .catch(err => console.error("Error loading heatmap data:", err));
    }

    // Load initial layer
    loadLayer("ai_score");

    // Change layer on select
    document.getElementById("layerSelect").addEventListener("change", e => {
        loadLayer(e.target.value);
    });

});
</script>

{% endblock %}
{% block extra_js %}
<script src="{% static 'js/dashboard/map.js' %}"></script>
{% endblock %}