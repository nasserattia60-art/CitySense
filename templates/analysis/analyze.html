{% extends "base/base.html" %}
{% load static %}
{% block title %}CitySense | analysis city or area{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href=" {% static 'css/analysis/analyze.css' %}">
{% endblock %}
{% block content %}
<h2>Analyze Location</h2>
<form method="post" class="analyze-form">
  {% csrf_token %}
  {{ form }}
  <ul id="suggestions"></ul>
  <button type="submit">Analyze</button>
  {% if error %}
    <p>{{ error }}</p>
  {% endif %}
</form>
{% endblock %}
{% block extra_js %}

<script>
const input = document.getElementById('id_address');
const suggestionsList = document.getElementById('suggestions');


const suggestionsURL = "{% url 'analysis:city_suggestions' %}";

let debounceTimeout;
input.addEventListener('input', () => {
    clearTimeout(debounceTimeout);

    debounceTimeout = setTimeout(async () => {
        const query = input.value.trim();
        if (!query) {
            suggestionsList.innerHTML = '';
            return;
        }

        const response = await fetch(`${suggestionsURL}?q=${encodeURIComponent(query)}`);
        const cities = await response.json();

        suggestionsList.innerHTML = cities.map(city =>
            `<li data-lat="${city.lat}" data-lon="${city.lon}">${city.name}</li>`
        ).join('');

        suggestionsList.querySelectorAll('li').forEach(li => {
            li.addEventListener('click', () => {
                input.value = li.textContent;
                suggestionsList.innerHTML = '';
                console.log('Lat:', li.dataset.lat, 'Lon:', li.dataset.lon);
            });
        });
    }, 250); // debounce 250ms
});
</script>

<style>
#suggestions {
    list-style: none;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    padding: 0;
    margin: 0;
}
#suggestions li {
    padding: 5px 10px;
    cursor: pointer;
}
#suggestions li:hover {
    background-color: #f0f0f0;
}
</style>
{% endblock %}
